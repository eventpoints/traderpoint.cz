{% extends 'base.html.twig' %}

{% block body %}
    <div class="container min-vh-100">
        <div class="row justify-content-center g-3 mt-3">

            <div class="col-12 col-md-4">
                <div class="card mb-3">
                    {% if engagement.quote and app.user == engagement.quote.owner %}
                        {{ ux_map(map, { style: 'height: 250px' }) }}
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between">
                                <div>{{ engagement.address }}</div>
                                <div></div>
                            </div>
                        </div>
                    {% endif %}
                    {% set hasMap = engagement.quote and app.user == engagement.quote.owner %}
                    <div class="card-header d-flex align-items-center {{ hasMap ? 'justify-content-between' : 'justify-content-end' }}">
                        {% if hasMap %}
                            <div class="dropdown">
                                <a class="btn btn-outline-primary rounded-pill" type="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    <i class="bi bi-map fs-4"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item"
                                           href="https://www.google.com/maps/search/?api=1&query={{ engagement.latitude }},{{ engagement.longitude }}"
                                           target="_blank">
                                            Open in Google Maps
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="http://maps.apple.com/?ll={{ engagement.latitude }},{{ engagement.longitude }}"
                                           target="_blank">
                                            Open in Apple Maps
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-header">
                        <div class="d-flex justify-content-start align-items-start gap-3">
                            <a href="{{ path('client_profile', {id: engagement.owner.id}) }}">
                                <img class="rounded-circle avatar-50" src="{{ engagement.owner.avatar }}">
                            </a>
                            <div class="">
                                <div class="fw-bold text-dark fs-4 lh-1">{{ engagement.title }}</div>
                                <div class="d-flex justify-content-start gap-3">
                                    <a href="{{ path('client_profile', {id: engagement.owner.id}) }}">{{ engagement.owner.fullName|title }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-header">
                        <div class="fs-4  d-flex flex-wrap gap-2">
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                          data-bs-title="{{ 'budget'|trans }}"
                                          class="badge hover-pointer rounded-pill text-bg-dark">{{ (engagement.budget / 100)|format_currency(engagement.currencyCodeEnum.value, {}, app.locale) }}</span>
                            {% for skill in engagement.skills %}
                                <span class="badge rounded-pill text-bg-primary">{{ skill.name|trans(domain='skills')|title }}</span>
                            {% endfor %}
                            <span class="badge rounded-pill text-bg-dark">{{ 'km.distance'|trans({distance: distance_km(engagement.latitude, engagement.longitude, app.user.traderProfile.latitude,app.user.traderProfile.longitude)}) }}</span>
                            <span class="badge rounded-pill text-bg-dark">{{ engagement.timelinePreferenceEnum.value|trans }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div data-controller="read-more"
                             data-read-more-more-text-value="{{ 'read-more'|trans }}"
                             data-read-more-less-text-value="{{ 'read-less'|trans }}">
                            <div class="read-more-content" data-read-more-target="content">
                                {{ engagement.description|nl2br }}
                            </div>
                            {% if engagement.description|length > 255 %}
                                <div class="text-center text-muted my-3">
                                    <a data-action="read-more#toggle">{{ 'read-more'|trans }}</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 justify-content-start" {{ stimulus_controller('lightbox') }}>
                            {% for image in engagement.images %}
                                <div href="{{ asset('uploads/images/' ~ image.filename) }}" class="col-6">
                                    <img src="{{ asset('uploads/images/' ~ image.filename) }}"
                                         class="w-100 object-fit-cover rounded-3 hover-pointer" style="height: 150px"/>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="list-group list-group-flush">
                        {% if engagement.quote and app.user == engagement.quote.owner %}
                            <div class="list-group-item d-flex d-flex justify-content-between align-items-center"
                                    {{ stimulus_controller('clipboard', {
                                        successContent: "<span class='bi bi-check-lg text-success fs-4'></span>"
                                    }) }}
                            >
                                <div class="w-75 lead"
                                     value="{{ '+420 749 783 873' }}" {{ stimulus_target('clipboard', 'source') }} >{{ '+420 749 783 873' }}</div>
                                <a class="me-2"
                                   href="#" {{ stimulus_action('clipboard', 'copy', 'click') }} {{ stimulus_target('clipboard', 'button') }} >
                                    <span class="bi bi-copy fs-4"></span>
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center fs-4">
                            {{ component('engagement_viewers', {engagement: engagement}) }}
                            <span class="badge rounded-pill bg-primary">{{ 'quotes-received'|trans({count: engagement.quotes.count}) }}</span>
                        </div>
                        <div class="text-muted text-center">{{ engagement.createdAt.diffForHumans }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                {% set acceptedQuote = engagement.quote %}
                {% set traderQuote = engagement.getMostRecentQuoteFor(app.user) %}

                {# 1) A quote has been accepted #}
                {% if acceptedQuote %}
                    {% if traderQuote and traderQuote.id == acceptedQuote.id %}
                        {# ✅ This trader WON #}
                        {{ include('engagement/_accepted_quote_summary.html.twig') }}

                        <div class="list-group-item text-end">
                            <a href="{{ path('engagement_issue', {quote: acceptedQuote.id, user: engagement.owner.id}) }}"
                               class="btn btn-outline-secondary rounded-pill">
                                {{ 'something-is-wrong'|trans }}
                            </a>
                        </div>
                    {% else %}
                        {# Another trader's quote was accepted #}
                        {% if traderQuote %}
                            <div class="text-center">
                                <div class="fs-4 mb-3">
                                    {{ ux_icon('mdi:close-circle-outline', { style: 'height: 1.8em;' }) }}
                                </div>
                                <div class="fw-bold fs-4">
                                    {{ 'quote-not-selected'|trans|capitalize }}
                                </div>
                                <div class="text-muted">
                                    {{ 'quote-not-selected-explainer'|trans }}
                                </div>
                            </div>
                        {% else %}
                            <div class="card">
                                <div class="card-body text-center text-muted">
                                    {{ 'quote-closed-already-accepted'|trans }}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}

                    {# 2) No accepted quote yet #}
                {% else %}
                    {% if traderQuote %}
                        {# Trader has already quoted → awaiting response #}
                        <div class="text-center">
                            <div class="fs-4 mb-3">
                                {{ ux_icon('mdi:clock-outline', { style: 'height: 1.5em;' }) }}
                            </div>
                            <div class="fw-bold">
                                {{ 'awaiting-client-response'|trans|capitalize }}
                            </div>
                            <div class="text-muted">
                                {{ 'awaiting-client-response-explainer'|trans }}
                            </div>
                        </div>
                        <hr/>
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-start">
                                <div class="fs-4">
                                    {{ traderQuote.price|format_currency(traderQuote.currency.value) }}
                                </div>
                                <div class="fs-4">
                        <span class="badge text-bg-primary rounded-pill">
                            {{ 'awaiting-response'|trans }}
                        </span>
                                </div>
                            </div>
                            <div class="card-header fs-4 d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge rounded-pill text-bg-dark">
                        {{ traderQuote.startAt|format_datetime }}
                    </span>
                                <span class="badge rounded-pill text-bg-dark">
                        {{ 'duration-in-hours'|trans({ duration: traderQuote.expectedDurationHours }) }}
                    </span>
                                <span class="badge rounded-pill text-bg-dark">
                        {{ traderQuote.includesMaterials
                        ? 'includes-materials'|trans
                        : 'does-not-includes-materials'|trans }}
                    </span>
                                <span class="badge rounded-pill text-bg-dark">
                        {{ 'warranty-duration-in-months'|trans({ duration: traderQuote.warrantyMonths }) }}
                    </span>
                            </div>
                            <div class="card-body">
                                {{ traderQuote.message|nl2br }}
                            </div>
                        </div>

                    {% else %}
                        {# Trader has not quoted & job still open → show quote form #}
                        {{ form_errors(quoteForm) }}
                        <div class="card">
                            {{ form_start(quoteForm) }}
                            <div class="card-header fs-5 fw-bold">
                                {{ 'send-quotation'|trans|title }}
                            </div>
                            <div class="card-body vstack gap-3">
                                {{ form_row(quoteForm.startAt) }}
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        {{ form_row(quoteForm.expectedDurationHours) }}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        {{ form_row(quoteForm.price) }}
                                    </div>
                                </div>
                                {{ form_row(quoteForm.includesMaterials) }}

                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        {{ form_row(quoteForm.warrantyMonths) }}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        {{ form_row(quoteForm.validUntil) }}
                                    </div>
                                </div>
                                {{ form_row(quoteForm.message) }}
                            </div>
                            <div class="card-footer text-end">
                                <button class="btn btn-lg btn-primary rounded-pill" type="submit">
                                    {{ 'submit'|trans }}
                                </button>
                            </div>
                            {{ form_end(quoteForm) }}
                        </div>
                    {% endif %}
                {% endif %}




                {# --- Public job chat / clarifications --- #}


                {{ include('engagement/_messages.html.twig', {messageForm: messageForm}) }}

            </div>

        </div>
    </div>
{% endblock %}
