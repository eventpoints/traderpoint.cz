services:
  php:
    image: ghcr.io/eventpoints/traderpoint.cz-php:main
    restart: unless-stopped
    environment:
      APP_URL: "https://traderpoint.cz"
      APP_ENV: "prod"
      MERCURE_PUBLIC_URL: "https://traderpoint.cz/.well-known/mercure"
      DATABASE_URL: "postgresql://__TRADERPOINT_POSTGRES_USER__:__TRADERPOINT_POSTGRES_PASSWORD__@database:5432/__TRADERPOINT_POSTGRES_DBNAME__?serverVersion=17&charset=utf8"
      MERCURE_JWT_SECRET: "__TRADERPOINT_MERCURE_JWT_SECRET__"
      APP_SECRET: "__TRADERPOINT_APP_SECRET__"
      MAILER_DSN: "__TRADERPOINT_MAILER_DSN__"
      MESSENGER_TRANSPORT_DSN: "__TRADERPOINT_MESSENGER_TRANSPORT_DSN__"
      APP_TIMEZONE: "__TRADERPOINT_APP_TIMEZONE__"
      STRIPE_PUBLIC_KEY: "__TRADERPOINT_STRIPE_PUBLIC_KEY__"
      STRIPE_PRIVATE_KEY: "__TRADERPOINT_STRIPE_PRIVATE_KEY__"
      STRIPE_WEBHOOK_SECRET: "__TRADERPOINT_STRIPE_WEBHOOK_SECRET__"
      MAILTRAP_TOKEN: "__TRADERPOINT_MAILTRAP_TOKEN__"
      MAILTRAP_API_TOKEN: "__TRADERPOINT_MAILTRAP_API_TOKEN__"
      OAUTH_GOOGLE_CLIENT_ID: "__TRADERPOINT_OAUTH_GOOGLE_CLIENT_ID__"
      OAUTH_GOOGLE_CLIENT_SECRET: "__TRADERPOINT_OAUTH_GOOGLE_CLIENT_SECRET__"
      OAUTH_FACEBOOK_CLIENT_ID: "__TRADERPOINT_OAUTH_FACEBOOK_CLIENT_ID__"
      OAUTH_FACEBOOK_CLIENT_SECRET: "__TRADERPOINT_OAUTH_FACEBOOK_CLIENT_SECRET__"
      JWT_QR_PRIVATE_KEY_PATH: "/app/config/jwt-qr/private.pem"
      JWT_QR_PUBLIC_KEY_PATH: "/app/config/jwt-qr/public.pem"
    volumes:
      - ./php/php.ini:/usr/local/etc/php/php.ini:ro
      - ./config/jwt-qr:/app/config/jwt-qr:ro
    healthcheck:
      # keep it simple in prod; FPM process up == OK
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    networks:
      - internal

  worker:
    image: ghcr.io/eventpoints/traderpoint.cz-php:main
    command: >
      php bin/console messenger:consume async -vv
      --time-limit=3600 --memory-limit=256M --sleep=1
    restart: unless-stopped
    depends_on:
      - database
    environment:
      APP_URL: "https://traderpoint.cz"
      APP_ENV: "prod"
      MERCURE_PUBLIC_URL: "https://traderpoint.cz/.well-known/mercure"
      DATABASE_URL: "postgresql://__TRADERPOINT_POSTGRES_USER__:__TRADERPOINT_POSTGRES_PASSWORD__@database:5432/__TRADERPOINT_POSTGRES_DBNAME__?serverVersion=17&charset=utf8"
      MERCURE_JWT_SECRET: "__TRADERPOINT_MERCURE_JWT_SECRET__"
      APP_SECRET: "__TRADERPOINT_APP_SECRET__"
      MAILER_DSN: "__TRADERPOINT_MAILER_DSN__"
      MESSENGER_TRANSPORT_DSN: "__TRADERPOINT_MESSENGER_TRANSPORT_DSN__"
      APP_TIMEZONE: "__TRADERPOINT_APP_TIMEZONE__"
      STRIPE_PUBLIC_KEY: "__TRADERPOINT_STRIPE_PUBLIC_KEY__"
      STRIPE_PRIVATE_KEY: "__TRADERPOINT_STRIPE_PRIVATE_KEY__"
      STRIPE_WEBHOOK_SECRET: "__TRADERPOINT_STRIPE_WEBHOOK_SECRET__"
      MAILTRAP_TOKEN: "__TRADERPOINT_MAILTRAP_TOKEN__"
      MAILTRAP_API_TOKEN: "__TRADERPOINT_MAILTRAP_API_TOKEN__"
      OAUTH_GOOGLE_CLIENT_ID: "__TRADERPOINT_OAUTH_GOOGLE_CLIENT_ID__"
      OAUTH_GOOGLE_CLIENT_SECRET: "__TRADERPOINT_OAUTH_GOOGLE_CLIENT_SECRET__"
      OAUTH_FACEBOOK_CLIENT_ID: "__TRADERPOINT_OAUTH_FACEBOOK_CLIENT_ID__"
      OAUTH_FACEBOOK_CLIENT_SECRET: "__TRADERPOINT_OAUTH_FACEBOOK_CLIENT_SECRET__"
      JWT_QR_PRIVATE_KEY_PATH: "/app/config/jwt-qr/private.pem"
      JWT_QR_PUBLIC_KEY_PATH: "/app/config/jwt-qr/public.pem"
    volumes:
      - ./php/php.ini:/usr/local/etc/php/php.ini:ro
      - ./config/jwt-qr:./config/jwt-qr:ro
    networks:
      - internal

  caddy:
    image: ghcr.io/eventpoints/traderpoint.cz-caddy:main
    restart: unless-stopped
    depends_on:
      - php
    environment:
      SERVER_NAME: ":80"                                  # Traefik terminates TLS
      MERCURE_PUBLISHER_JWT_KEY: "__TRADERPOINT_MERCURE_JWT_SECRET__"
      MERCURE_SUBSCRIBER_JWT_KEY: "__TRADERPOINT_MERCURE_JWT_SECRET__"
    volumes:
      - ./public:/app/public:ro
      - caddy_data:/data
      - caddy_config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    expose:
      - "80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traderpoint.rule=Host(`traderpoint.cz`, `www.traderpoint.cz`)"
      - "traefik.http.routers.traderpoint.entrypoints=websecure"
      - "traefik.http.routers.traderpoint.tls=true"
      - "traefik.http.routers.traderpoint.tls.certresolver=le"
      - "traefik.docker.network=traefik"
    networks:
      - traefik
      - internal

  database:
    image: postgis/postgis:16-3.4
    restart: unless-stopped
    environment:
      POSTGRES_DB: "__TRADERPOINT_POSTGRES_DBNAME__"
      POSTGRES_PASSWORD: "__TRADERPOINT_POSTGRES_PASSWORD__"
      POSTGRES_USER: "__TRADERPOINT_POSTGRES_USER__"
    volumes:
      - ./db-data:/var/lib/postgresql/data:rw
    networks:
      - internal

  adminer:
    image: adminer:4.8.0
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: database
    ports:
      - "8081:8080"
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.traderpoint-adminer.rule=Host(`adminer.traderpoint.cz`)
      - traefik.http.routers.traderpoint-adminer.entrypoints=websecure
      - traefik.http.routers.traderpoint-adminer.tls=true
      - traefik.http.routers.traderpoint-adminer.tls.certresolver=le
      - traefik.http.services.traderpoint-adminer.loadbalancer.server.port=8080
    networks:
      - internal
      - traefik

networks:
  traefik:
    external: true
  internal:
    external: false

volumes:
  caddy_data:
  caddy_config:
