networks:
  traefik:
    external: true
  internal:
    external: false

volumes:
  php_socket:
  caddy_data:
  caddy_config:

services:
  php:
    image: ghcr.io/eventpoints/traderpoint.cz-php:main
    volumes:
      - php_socket:/var/run/php
      - ./php/php.ini:/usr/local/etc/php/php.ini
    healthcheck:
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    depends_on:
      - database
    restart: unless-stopped
    environment:
      APP_ENV: "prod"
      APP_SECRET: "__TRADERPOINT_APP_SECRET__"
      DATABASE_URL: "postgresql://__TRADERPOINT_POSTGRES_USER__:__TRADERPOINT_POSTGRES_PASSWORD__@__TRADERPOINT_POSTGRES_HOST__:__TRADERPOINT_POSTGRES_PORT__/__TRADERPOINT_POSTGRES_DBNAME__?serverVersion=13&charset=utf8"
      MAILER_DSN: "__TRADERPOINT_MAILER_DSN__"
      MESSENGER_TRANSPORT_DSN: "__TRADERPOINT_MESSENGER_TRANSPORT_DSN__"
      MERCURE_PUBLIC_URL: "https://traderpoint.cz/.well-known/mercure"
      MERCURE_JWT_SECRET: "__TRADERPOINT_MERCURE_JWT_SECRET__"
      RECAPTCHA3_KEY: "__TRADERPOINT_RECAPTCHA3_KEY__"
      RECAPTCHA3_SECRET: "__TRADERPOINT_RECAPTCHA3_SECRET__"
    networks:
      - internal

  caddy:
    image: ghcr.io/eventpoints/traderpoint.cz-caddy:main
    depends_on:
        - php
    restart: unless-stopped
    environment:
        SERVER_NAME: ":80"
        MERCURE_PUBLISHER_JWT_KEY: "__TRADERPOINT_MERCURE_JWT_SECRET__"
        MERCURE_SUBSCRIBER_JWT_KEY: "__TRADERPOINT_MERCURE_JWT_SECRET__"
    volumes:
        - php_socket:/var/run/php
        - caddy_data:/data
        - caddy_config:/config
        - ./Caddyfile:/etc/caddy/Caddyfile
    expose:
        - "80"
    labels:
        - "traefik.enable=true"
        - "traefik.http.routers.traderpoint.rule=Host(`traderpoint.cz`)"
        - "traefik.http.routers.traderpoint.tls=true"
        - "traefik.http.routers.traderpoint.tls.certresolver=le"
    networks:
        - traefik
        - internal

  supervisor:
      image: okteto/supervisor:0.4.0
      container_name: supervisor
      volumes:
          - ./supervisor:/supervisor  # Mount your supervisor config
      environment:
          - SUPERVISOR_CONFIG=/supervisor/supervisord.conf  # Define the config path
      networks:
          - internal
      depends_on:
          - php
      restart: always

  adminer:
    image: adminer:4.8.0
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: database
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traderpoint-adminer.rule=Host(`adminer.traderpoint.cz`)"
      - "traefik.http.routers.traderpoint-adminer.tls=true"
      - "traefik.http.routers.traderpoint-adminer.tls.certresolver=le"
    networks:
      - internal
      - traefik
